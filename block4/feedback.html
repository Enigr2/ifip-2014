<!DOCTYPE html>
<html>
<head>
  <title>geoweb.m10 - Feedback</title>
  <script type="text/javascript" src="http://openlayers.org/en/v3.0.0/build/ol.js"></script>
</head>
<body>
  <h2>Feedback-Formular</h2>
  <form action="javascript:submitForm();">
    <input type="radio" name="geschlecht" value="Frau"/> Frau
    <input type="radio" name="geschlecht" value="Herr"/> Herr<br />
    <table>
      <tr><td>Name:</td>
         <td><input type="text" name="name" size="50" /></td>
      </tr>
      <tr><td>E-Mail: </td>
         <td><input type="text" name="email" size="50" /></td>
      </tr>
    </table>
    Feedback: <br />
    <textarea name="message" rows="10" cols="50"></textarea>
    <br />
    <input type="checkbox" name="team" checked="checked" value="ON" />
           Ich bin Mitglied des geoweb-Teams
    <br /><br />
    Location: <br />
    latitude: <input type="text" name="lat" size="15" readonly />
    longitude: <input type="text" name="lon" size="15" readonly />
    <br /><br />
    <input type="submit" value="Abschicken">
    <input type="reset" value="ZurÃ¼cksetzen"> <br /><br />
    Ihr Feedback wird per E-Mail an die Autoren/innen zugestellt<br>
    und in der Projekt-Datenbank gespeichert.<br /><br />
    <br />
  </form>
  <script type="text/javascript">
    var form = document.forms[0];

    var geolocation = new ol.Geolocation({
      projection: 'EPSG:4326'
    });
    // listen to changes in position
    geolocation.setTracking(true);
    geolocation.on('change', function(evt) {
      geolocation.setTracking(false);
      var location = geolocation.getPosition();
      form.lon.value = location[0];
      form.lat.value = location[1];
    });

    function submitForm() {
      var feature = new ol.Feature();
      if (form.lon.value && form.lat.value) {
        feature.setGeometryName('geom');
        feature.setGeometry(new ol.geom.Point(
            [parseFloat(form.lon.value), parseFloat(form.lat.value)]));
      }
      feature.set('f_name', form.name.value);
      feature.set('f_mail', form.email.value);
      for (var i = form.geschlecht.length - 1; i >= 0; --i) {
        if (form.geschlecht[i].checked) {
          feature.set('f_anrede', form.geschlecht[i].value);
          break;
        }
      }
      feature.set('f_msg', form.message.value);
      feature.set('f_geoweb', form.team.checked ? 1 : 0);
      var date = new Date();
      feature.set('f_datum',
          date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate());
      
      var transaction = new ol.format.WFS().writeTransaction([feature], null, null, {
        featureType: 'feedback',
        featureNS: 'http://geoweb/2014/ifip',
        gmlOptions: {srsName: 'EPSG:4326'}
      });

      var request = new XMLHttpRequest();
      request.open('POST', 'http://student.ifip.tuwien.ac.at/geoserver/wfs', true);
      request.onload = function() {
        alert(request.responseText);
      }
      request.send(new XMLSerializer().serializeToString(transaction));
    }
  </script>
</body>
</html>
